{% extends "base.html" %}

{% block title %}Detalhes de {{ organizacao.nome }} - DataCheckAI{% endblock %}

{% block content %}
<div class="organizacao-header">
    <h2>Migração de Dados - {{ organizacao.nome }}</h2>
    <div class="info-organizacao">
        <p><strong>Código:</strong> {{ organizacao.codigo }}</p>
        <div class="cnpjs-list">
            <strong>CNPJs:</strong>
            <ul>
                {% for cnpj in organizacao.cnpjs|sort(attribute='is_matriz', reverse=True) %}
                    <li>{{ cnpj.numero }} {% if cnpj.is_matriz %}(Matriz){% else %}(Filial){% endif %}</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

<div class="upload-section">
    <h3>Iniciar Nova Migração</h3>
    <p>Para iniciar uma nova migração de dados, selecione um dos layouts de importação.</p>
    <a href="{{ url_for('selecionar_layout', organizacao_id=organizacao.id) }}" class="btn btn-primary">
        <i class="fas fa-file-upload"></i> Iniciar Nova Migração
    </a>
</div>

<div class="sessoes-historico">
    <h3>Histórico de Processamento</h3>
    {% if sessoes %}
    <table class="historico-table">
        <thead>
            <tr>
                <th>Módulo</th>
                <th>Arquivo Original</th>
                <th>Data</th>
                <th>Total de Registros</th>
                <th>Registros Válidos</th>
                <th>Status</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for sessao in sessoes %}
            <tr>
                <td>{{ sessao.modulo|capitalize }}</td>
                <td>{{ sessao.arquivo_original }}</td>
                <td>{{ sessao.data_processamento.strftime('%d/%m/%Y %H:%M') }}</td>
                <td>{{ sessao.total_registros }}</td>
                <td>{{ sessao.registros_validos }}</td>
                <td><span class="status status-{{ sessao.status }}">{{ sessao.status }}</span></td>
                <td>
                    {% if sessao.arquivo_gerado %}
                    <a href="{{ url_for('download_arquivo', sessao_id=sessao.id) }}" class="btn btn-sm">Download TXT</a>
                    {% else %}
                    <span>-</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>Nenhum arquivo foi processado para esta organização ainda.</p>
    {% endif %}
</div>
{% endblock %}