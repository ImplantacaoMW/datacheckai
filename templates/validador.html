{% extends "base.html" %}

{% block title %}Validador: {{ nome_rotina }} - {{ organizacao.nome }}{% endblock %}

{% block content %}
<div class="validator-header">
    <h2>Validador de Layout: {{ nome_rotina }}</h2>
    <p>Organização: <strong>{{ organizacao.nome }}</strong> (Código: {{ organizacao.codigo }})</p>
</div>

<!-- 1. Upload Form (shown if no mapping or results are in session) -->
{% if not mapear and not inconsistencias %}
<div class="upload-section form-container">
    <h3>Passo 1: Enviar Arquivo para Validação</h3>
    <p class="format-info">Formatos suportados: <strong>.csv, .txt, .xlsx</strong></p>
    <form action="{{ url_for('validador', organizacao_id=organizacao.id, tipo=tipo) }}" method="POST" enctype="multipart/form-data" id="upload-form">
        <div class="form-group">
            <label for="arquivo">Selecione o arquivo:</label>
            <input type="file" name="arquivo" id="arquivo" required>
        </div>
        <div class="form-actions">
            <a href="{{ url_for('selecionar_layout', organizacao_id=organizacao.id) }}" class="btn btn-secondary">Voltar</a>
            <button type="submit" class="btn btn-primary">Processar Arquivo</button>
        </div>
    </form>
</div>
{% endif %}


<!-- 2. Mapping Interface (shown if there's a file to be mapped) -->
{% if mapear %}
<div class="mapping-container">
    <h3>Passo 2: Mapear Colunas do Arquivo</h3>
    <form id="formMapear" action="{{ url_for('validador_mapear', tipo=tipo) }}" method="post">
        {% for arquivo in mapear %}
        <div class="mapear-bloco">
            <h4>Arquivo: {{ arquivo.nome }} ({{ arquivo.num_registros }} registros)</h4>

            <div class="auto-map-aviso">
                <p><strong>Mapeamento Automático (IA):</strong> As sugestões abaixo foram geradas por IA. Revise e ajuste se necessário.</p>
            </div>

            <table class="tabela-mapear">
                <thead>
                    <tr>
                        <th>Campo do Layout</th>
                        <th>Sua Coluna no Arquivo</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="grupo-titulo"><td colspan="2">Campos Obrigatórios</td></tr>
                    {% for campo, label, _, _, obrigatorio in layout if obrigatorio %}
                    <tr>
                        <td>{{ label }}</td>
                        <td>
                            <select name="{{ arquivo.nome }}_{{ campo }}" required>
                                <option value="">Selecione...</option>
                                {% for col in arquivo.colunas %}
                                <option value="{{ col }}" {% if arquivo.auto_map.get(campo) == col %}selected{% endif %}>{{ col }}</option>
                                {% endfor %}
                            </select>
                        </td>
                    </tr>
                    {% endfor %}
                    <tr class="grupo-titulo"><td colspan="2">Campos Opcionais</td></tr>
                    {% for campo, label, _, _, obrigatorio in layout if not obrigatorio %}
                    <tr>
                        <td>{{ label }}</td>
                        <td>
                            <select name="{{ arquivo.nome }}_{{ campo }}">
                                <option value="">Selecione...</option>
                                {% for col in arquivo.colunas %}
                                <option value="{{ col }}" {% if arquivo.auto_map.get(campo) == col %}selected{% endif %}>{{ col }}</option>
                                {% endfor %}
                            </select>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endfor %}
        <div class="form-actions">
             <a href="{{ url_for('validador', organizacao_id=organizacao.id, tipo=tipo) }}" class="btn btn-secondary">Cancelar</a>
            <button type="submit" class="btn btn-primary">Confirmar Mapeamento e Analisar</button>
        </div>
    </form>
</div>
{% endif %}


<!-- 3. Results Display (shown after mapping) -->
{% if inconsistencias is not none and stats is not none %}
<div class="results-container">
    <h3>Passo 3: Resultados da Análise</h3>
     <div class="actions">
        <a href="{{ url_for('validador', organizacao_id=organizacao.id, tipo=tipo) }}" class="btn btn-primary">Analisar Outro Arquivo</a>
        <a href="{{ url_for('detalhes_organizacao', organizacao_id=organizacao.id) }}" class="btn btn-secondary">Ver Histórico da Organização</a>
    </div>

    <!-- This section can be further developed to show the analysis results -->
    <p style="margin-top: 1rem;">A análise foi concluída. Os resultados estão disponíveis na página de detalhes da organização.</p>
</div>
{% endif %}

{% endblock %}